﻿//################################
//ST Query (String Query)
//Author: Steve Tomlin
//Date updated: 2011-07-08_2000
//Version: 0.8 Alpha
//Licence: MIT or GNU
(function(){var a={encodeReg:function(a){return a.replace(/([^\w\d\s])/gi,"\\$1")},trim:function(a){return a.replace(/^(\s+|\s+)$/,"")},trimFromSquareBrackets:function(a){a=a.replace(/\[\s+/g,"["),a=a.replace(/\s+\]/g,"]");return a},convertMultipleToSingleWhitespace:function(a){return a.replace(/ {2,}/g," ")},getRegexParenthesisNumber2:function(a,b,c,d,e){var f=c+"("+d+")"+e;if(a.search(RegExp(f))===-1)return null;var g=function(a){return new RegExp(c+"("+a+")"+e)},h=d.split("|"),i,j;for(var k=0,l=h.length;k<l;++k){i=g(h[k]),j=i.exec(i);if(j)return{intP:k,strMatch:j[1]}}return null},getRegexParenthesisNumber1:function(a,b,c,d,e){var f=c+"("+d+")"+e;if(a.search(RegExp(f))===-1)return null;var g=b,h="0102030405060708091011121314151617181920",i=function(a){a=a<10?"0"+a:a;return"\\s*"+g+"[^"+g+"]*"+a},j=1;d=d.replace(/\|/g,function(){var a=i(j)+"|";j=j+1;return a}),d=d+i(j),a=a.replace(RegExp("("+e+")"),g+h+g+"$1");var k=c+"("+d+")[^"+g+"]*"+g+e,l=RegExp(k),m=l.exec(a);if(m){var n=""+m[1],o=n.substr(n.length-2),p=parseInt(o)-1;return{intP:p,strMatch:n}}return null}},b=function(){this.strUsedMarkers="",this.objM={},this.strAvailableMarkers="~\u00ac\u2020\u2021\u2030\u00ac\u00bf\u00de~`\u00fc\u00a4\u00b1\u00c6\u00b8\u00b3\u00bf\u00b2\u00ba\u00ff";if(arguments.length>0){var a=arguments[0],b=arguments[1];this.addMarkers(a,b)}};b.prototype={addMarkers:function(a,b){var c=this.strAvailableMarkers,d=this.objM,e=this.strUsedMarkers,f=b.split(","),g=f.length,h=0,i;while(c!==""){i=c.substring(0,1);if(a.indexOf(i)==-1){d[f.pop()]=i,e+=i,++h;if(h===g){c=c.substr(1);break}}c=c.substr(1)}if(h<g){trace("Apparently all of the above markers have been used : "+c);return null}this.strUsedMarkers=e,this.strAvailableMarkers=c;return d},clearRegMarkers:function(a){var b=this.strUsedMarkers;a=a.replace(RegExp("["+b+"](\\d+ )?","g"),"");return a}};var c=function(){this.arrMasksMultiple=[],this.arrMasksSingle=[],this.strMarker=null,this.strMarkerMaskName="strMarkerMask"};c.prototype={init:function(a){this.objMarkers=a},mask:function(a){var b="<!--";a.indexOf(b)!==-1&&(a=this.maskEach(a,"COMMENTS",b,"-->",!1)),b="<![CDATA[",a.indexOf(b)!==-1&&(a=this.maskEach(a,"CDATAS",b,"]]>",!1)),b="<script",a.indexOf(b)!==-1&&(a=this.maskEach(a,"SCRIPTS",b+"[^>]*>","</script>",!0)),b="<style",a.indexOf(b)!==-1&&(a=this.maskEach(a,"STYLES",b+"[^>]*>","</style>",!0));var c=[],d,e,f;b="<?xml",a.indexOf(b)!==-1&&(d=/<\?xml[^>]*\?>/,e="strReplaceXmlDec",f=""+a.match(d),a=a.replace(d,e),c.push([f,e])),b="<!DOCTYPE",a.indexOf(b)!==-1&&(d=/<!DOCTYPE[^>]*>/,e="strReplaceDocType",f=""+a.match(d),a=a.replace(d,e),c.push([f,e])),this.arrMasksSingle=c;return a},maskEach:function(b,c,d,e,f){var g=this.strMarker;if(!g){var h=this.strMarkerMaskName,i=this.objMarkers.addMarkers(b,h);g=i[h],this.strMarker=g}var j=[];b=b.replace(RegExp("("+e+")","g"),"$1"+g);var k=f?d:a.encodeReg(d),l=f?e:a.encodeReg(e),m=f?"("+k+")":"()"+k,n=f?"("+l+")":"()"+l,o=m+"([^"+g+"]*)"+n+g,p=RegExp(o,"g"),q,r="";b=b.replace(p,function(a,b,d,e){q=c+"["+j.length+"]",j.push(d);var f=b+q+r+g+e;return f}),this.arrMasksMultiple.push([j,RegExp(c+"\\[(\\d+)\\][^"+g+"]*"+g,"g"),[f,d,e]]);return b},unmask:function(a){var b=this.arrMasksMultiple,c=this.arrMasksSingle,d,e,f;for(d=b.length-1;d>-1;--d){var g=b[d][2],h=g[0],i=h?"":g[1],j=h?"":g[2];e=b[d][1],f=b[d][0];while(a.search(e)!==-1)a=a.replace(e,function(a,b){return i+f[parseInt(b,10)]+j})}var k,l,m;for(d=c.length-1;d>-1;--d)k=c[d][0],l=c[d][1],m=RegExp(l),a=a.replace(m,k);return a}};var d=function(a){return new e(a)},e=function(d){this.v="alpha 0.8",this.dateStamp="2011-07-08_2000",this.supported="Mixed seperated selectors. Exmaple: #parent .category .subcat p",this.notSupported="chained classes. Example: .class.class.class",this.objMarkers=new b,this.objMasks=new c,d=a.trim(d),this.initMarkers(d),this.strHTML=this.wrapTagPointers(d)};e.prototype={shared:{intLastWrappedPointer:0},initMarkers:function(a){var b=this.objMarkers,c=b.addMarkers(a,"strMarkerHandle,strMarkerStart,strMarkerEnd")},wrapTagPointers:function(a){if(a.search(/[<>]/)!==-1){var b=this.objMarkers,c=b.objM,d=c.strMarkerHandle,e=c.strMarkerStart,f=c.strMarkerEnd,g=this.objMasks;g.init(b),a=g.mask(a),a=a.replace(/(<\w+([\s\:][^>]*[^\/])?>)/g,e+"$1"),a=a.replace(/(<\/\w+([\s\:][^>]*)?>)/g,"$1"+f);var h=new RegExp("([^"+e+"]<[^/]([^>]*[^/]>)?>|</[^>]*>[^"+f+"])");if(a.search(h)!=-1){var i=h.exec(a),j=i.index,k=a.substring(0,j),l=k.split(/\n/),m=l.length,n=l[m-1].length;trace("HTML not well formed. Tags not properly opened and closed:"),trace("intLineNumber ="+m),trace("intChar ="+n),trace("strGoodHTML="+k),trace("strBadHTML="+a.substr(j));return""}var o=this.shared,p=o.intLastWrappedPointer,q=RegExp(e+"(<[^\\/][^"+e+f+"]*[^\\/]>)"+f,"g"),r=function(){var a=arguments,b=d+p+" "+a[1]+(d+p+" ");++p;return b};while(a.search(q)!==-1)a=a.replace(q,r);a=a.replace(/(\<[^>]*\/>)/g,r),o.intLastWrappedPointer=p,a=g.unmask(a)}else trace("You have not supplied any html!");return a},replaceMarkers:function(a,b,c){return a.replace(RegExp(b+"(\\d+ )","g"),c+"$1")},removeTagPointers:function(a){var b=this.objMarkers.objM.strMarkerHandle;a=a.replace(RegExp(b+"\\d+ ","g"),""),a=a.replace(RegExp(b,"g"),"");return a},incrementTagPointers:function(a,b){var c=this.shared.intLastWrappedPointer;return a.replace(RegExp("("+b+"(\\d+) )([\\w\\W]*)\\1","g"),function(a,d,e,f){var g=b+c+" "+f+b+c+" ";++c;return g})},renewAndWrapTagPointers:function(a){var c=this.html(),d=new b(c+a,"strMarkerHandle,strMarkerStart,strMarkerEnd"),e=this.objMarkers.objM.strMarkerHandle,f=d.objM.strMarkerHandle;this.strHTML=this.replaceMarkers(this.strHTML,e,f),this.objMarkers=d,a=this.wrapTagPointers(a);return a},find:function(){var a=new f(this),b=arguments[0];return a.find(b)},html:function(){var a=this.strHTML;a=this.objMarkers.clearRegMarkers(a);return a},top:function(){var a=new f(this);return a.top()}};var f=function(a){this.objInst=a};f.prototype={arrPointers:[],objInst:{},objFindFn:{parseSelectors:function(b){b=a.convertMultipleToSingleWhitespace(b),b=a.trimFromSquareBrackets(b);return b},findAllCommas:function(a,b,c,d){var e=f.prototype,g,h=d.objMarkers.objM.strMarkerHandle;a=this.parseSelectors(a);var i=b;if(c.length){var j=c[0];i=e.extract(h,j,b)}var k=[i],l=a.split(","),m=[];for(var n=0,o=l.length;n<o;++n)g=this.findCollatedSpaced(l[n],k,h),m=m.concat(g);m=m.reverse();return m},parseSelector:function(b){var c=/\[([^\]]*)\]/g;b=a.trim(b);if(b.search(c)==-1)return b.split(" ");b=b.replace(/ /g,"\u00a4"),b=b.replace(c,function(a,b){return"["+b.replace(/¤/g," ")+"]"});return b.split(/¤+/g)},findCollatedSpaced:function(a,b,c){var d=this.parseSelector(a),e=b,g,h=f.prototype;for(var i=0,j=d.length;i<j;++i){var k=d[i],l=[];g=[];for(var m=0,n=e.length;m<n;++m){var o=e[m],p=this.findMultipleSelectors(k,o,c,h);for(var q=0,r=p.length;q<r;++q){var s=p[q];l.push(h.extract(c,s,o))}g=g.concat(p)}e=l}return g},findMultipleSelectors:function(a,b,c,d){var e=c+"(\\d+)\\s",f=a.charAt(0);f=f.replace(/[^\.\#]/,"TAG");return this.selectorChoice[f](a,b,e,c,d)},selectorChoice:{"#":function(){return arguments[4].objFindFn.findId.apply(this,arguments)},".":function(){return arguments[4].objFindFn.findClasses.apply(this,arguments)},TAG:function(){return arguments[4].objFindFn.findTags.apply(this,arguments)}},findId:function(a,b,c,d,e){var f=a.substr(1).split(/[\[\.\#]/)[0],g=c+'<[^>]*id="'+f+'"',h=e.objFilterFn.filter(a,g,b,d);if(h)return[h];var i=RegExp(g,""),j=i.exec(b);if(j)return[j[1]];return[]},findTags:function(a,b,c,d,e){var f=[],g=a.split(/[\[\.\#]/)[0],h="<"+g+"[\\s:\\/>]",i=e.objFilterFn.filter(a,h,b,d);i?f.push(i):f=this.iterateEachPointer(c+h,b);return f},findClasses:function(a,b,c,d,e){var f=[],g=a.substr(1).split(/[\[\.\#]/)[0],h='<[^>]*class="?[^"]*["\\s]'+g+'["\\s]',i=e.objFilterFn.filter(a.substr(1),h,b,d);i?f.push(i):f=this.iterateEachPointer(c+h,b);return f},iterateEachPointer:function(a,b){var c=[],d=RegExp(a,"g"),e;while(e=d.exec(b)){var f=""+e[1];c.push(f)}return c}},objFilterFn:{filter:function(b,c,d,e){if(b.indexOf("[")!=-1){var f='\\d+|\\w+|\\w+\\*\\="[^"]*"',g="filterPos,filterHasAttr,filterAttrContains",h=a.getRegexParenthesisNumber1(b,"\u00a4","\\[\\s*",f,"\\s*\\]");if(h){var i=h.intP,j=h.strMatch,k=g.split(","),l=k[i];return this[l](b,c,d,e)}}return null},filterPos:function(a,b,c,d){var e=null,f=this.extractPos(a);if(f){var g=RegExp(b,"g");e=this.getPositionedPointer(c,f,g,d)}return e},filterHasAttr:function(a,b,c,d){return null},filterAttrContains:function(a,b,c,d){return null},extractPos:function(a){var b=null,c=/^[^\.]*\[\s*(\d+)\s*\]/,d=RegExp(c).exec(a);d&&(b=parseInt(d[1]));return b},getPositionedPointer:function(a,b,c,d){var e=null;if(a.search(c)!==-1){var f=a.split(c),g=f[b];e=this.convertRegPointerToHTMLPointer(g,d)}return e},convertRegPointerToHTMLPointer:function(a,b){var c=null,d=RegExp(b+"(\\d+)\\s"),e=d.exec(a);e&&(c=""+e[1]);return c}},find:function(a){var b=this.objInst.strHTML,c=this.objInst;this.arrPointers=this.objFindFn.findAllCommas(a,b,this.arrPointers,c);return this},extract:function(a,b,c){if(b!==""){var d=a+b+" ";c.indexOf(d)!==-1?c=c.substring(c.indexOf(d),c.lastIndexOf(d)+d.length):trace("Note: strPointer: '"+b+"' does not exist")}return c},regexEach:function(a,b,c,d,e){var f=this.objInst,g=this.arrPointers,h=f.objMarkers.objM.strMarkerHandle,i=0,j=g.length,k,l;j&&d!=="all"&&(d==="first"?i=j-1:j=1);var m=function(a){k=g[a],l=h+k+" ";return"("+l+b+l+")"},n;if(e)for(;i<j;++i){n=m(i);var o=RegExp(n,"g");if(a.search(o)!==-1)a=a.replace(o,function(){return c(arguments)});else{var p="("+l+"<[^>]*)>",q=RegExp(p,"");a=a.replace(q,"$1 "+e[0]+'="'+e[1]+'">')}}else for(;i<j;++i)n=m(i),a=a.replace(RegExp(n,"g"),function(){return c(arguments)});return a},regexAttr:function(b,c,d,e,f,g){var h=this.objInst;b=a.trim(b),c=a.trim(c);var i=g?[b,c]:null;h.strHTML=this.regexEach(h.strHTML,d,e,f,i)},regexElem:function(b,c,d,e){var f=this.objInst;b=a.trim(b),b.indexOf("<")!=-1&&(b=this.objInst.renewAndWrapTagPointers(b)),f.strHTML=this.regexEach(f.strHTML,c,d,e,null),this.arrPointers=[f.shared.intLastWrappedPointer-1];return this},append:function(a){return this.regexElem(a,"<[^>]*>[\\w\\W]*)(<\\/[^>]*>",function(b){return b[1]+a+b[2]},"all")},prepend:function(a){return this.regexElem(a,"<[^>]*>)([\\w\\W]*<\\/[^>]*>",function(b){return b[1]+a+b[2]},"all")},before:function(a){return this.regexElem(a,"[\\w\\W]*",function(b){return a+b[1]},"all")},after:function(a){return this.regexElem(a,"[\\w\\W]*",function(b){return b[1]+a},"all")},getOuterHTMLArray:function(){var a=arguments.length>0?arguments[0]:function(a){return a},b=this.objInst,c=b.objMarkers.objM.strMarkerHandle,d=b.strHTML,e=this.arrPointers,f=[],g,h,i,f=[];for(var j=0,k=e.length;j<k;++j)g=e[j],h=c+g+" ",i=d.substring(d.indexOf(h)+h.length,d.lastIndexOf(h)),i=a(i),i=i.replace(RegExp(c+"\\d+ ","g"),""),f.push(i);return f},html:function(){var a=arguments.length>0?arguments[0]:null;if(a)return this.regexElem(a,"<[^>]*>)[\\w\\W]*(<\\/[^>]*>",function(b){return b[1]+a+b[2]},"all");var b=this.getOuterHTMLArray(function(a){return a=a.substring(a.indexOf(">")+1,a.lastIndexOf("</"))});return b.join()},outerHtml:function(){var a=arguments.length>0?arguments[0]:null;if(a)return this.regexElem(a,")<[^>]*>[\\w\\W]*<\\/[^>]*>(",function(b){return b[1]+a+b[2]},"all");var b=this.getOuterHTMLArray();return b.join("\n")},clone:function(){return this.html()},appendSibling:function(){var a=this.objInst,b=this.objInst.objMarkers.objM.strMarkerHandle;return this.regexElem("","[\\w\\W]*",function(c){var d=c[1];d=a.incrementTagPointers(d,b);return c[0]+d},"last")},attr:function(a){var b=arguments.length>1?arguments[1]:null,c=b;if(b){this.regexAttr(a,b,"<[^>]*"+a+'="?)[^"]*([\\w\\W]*"',function(a){return a[1]+b+a[2]},"all",c);return this}var d=this.arrPointers;if(d.length){var e=this.objInst.strHTML,f=d[0],g=this.objInst.objMarkers.objM.strMarkerHandle,h=g+f+" ",i=e.substring(e.indexOf(h)+h.length,e.lastIndexOf(h)),j=RegExp("<[^>]*"+a+'="?([^"]*)"',""),k=j.exec(i);if(k)return k[1]}return null},id:function(a){var b=a;this.regexAttr("id",a,'<[^>]*id="?)[^"]*("[\\w\\W]*',function(a){return a[1]+b+a[2]},"first",!0)},addClass:function(a){this.regexAttr("class",a,'<[^>]*class="?)([^"]*)("[\\w\\W]*',function(b){return b[1]+b[2]+" "+a+b[3]},"all",!0)},remove:function(){return this.regexElem("","[\\w\\W]*",function(a){return""},"all")},empty:function(){return this.regexElem("","<[^>]*>)[\\w\\W]*(<\\/[^>]*>",function(a){return a[1]+a[2]},"all")},removeClass:function(a){this.regexAttr("class",a,'<[^>]*class="?[^"]*[" ])'+a+'([ "][\\w\\W]*',function(a){return a[1]+a[2]},"all",!0);return this},removeAttr:function(a){this.regexAttr(a,"","<[^>]*)"+a+'="?[^"]*"([\\w\\W]*',function(a){return a[1]+a[2]},"all",!1);return this},objParentFn:{getEachParentPointer:function(a,b,c){var d=a+b+" ",e=a+"\\d+ ",f=a+"(\\d+) <([^\\/][^>]*[^\\/]|[\\w])>[^"+a+"]*([^"+a+"]*("+e+")[\\w\\W]*\\4){0,}"+d+"<[^\\/]",g=RegExp(f),h=g.exec(c);if(!h)return null;var i=h[1];return i},getTraversedParentsPointer:function(a,b,c,d){var e=this.getEachParentPointer(a,b,d);if(!e)return null;return this.getClosestPointer(a,b,c,d,e)},getClosestPointer:function(a,b,c,d,e){var f=c.indexOf(","+e+",")!=-1;return f?e:this.getTraversedParentsPointer(a,e,c,d)},getSelfPointer:function(a,b,c,d){return this.getClosestPointer(a,b,c,d,b)},getSingleParentPointer:function(a,b,c){return this.getEachParentPointer(a,b,c)}},parents:function(){var a=arguments.length,b=a>0?arguments[0]:null,c=a>1?!0:!1,d=null,e=this.objInst,f=e.strHTML;if(b){var g=this.objFindFn.findAllCommas(b,f,[],e);d=","+g.join(",")+","}var h=this.objInst.objMarkers.objM.strMarkerHandle;f=f+"<allowtop></allowtop>";var i=[],j=this.arrPointers,k=this.objParentFn;for(var l=0,m=j.length;l<m;++l){var n=j[l],o=null;a?c?o=k.getSelfPointer(h,n,d,f):o=k.getTraversedParentsPointer(h,n,d,f):o=k.getSingleParentPointer(h,n,f),o&&i.push(o)}this.arrPointers=i;return this},parent:function(){return this.parents()},closest:function(a){return this.parents(a,!0)},top:function(){var a=this.objInst,b=a.objMarkers.objM.strMarkerHandle,c=RegExp("^\\s*"+b+"(\\d+) "),d=c.exec(a.strHTML);d&&(this.arrPointers=[d[1]]);return this}},window.STQuery=d})(window)